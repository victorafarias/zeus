version: "3.8"

services:
  # =====================================================
  # ZEUS BACKEND - Servidor Principal
  # Container que roda a API FastAPI com o agente de IA
  # Também serve o frontend como arquivos estáticos
  # =====================================================
  zeus-backend:
    build: ./backend
    container_name: zeus-backend
    restart: unless-stopped

    # Permite acesso ao Ollama rodando no host
    extra_hosts:
      - "host.docker.internal:host-gateway"

    # Variáveis de ambiente carregadas do arquivo .env
    environment:
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY}
      - SECRET_KEY=${SECRET_KEY}
      - AUTH_USERNAME=${AUTH_USERNAME}
      - AUTH_PASSWORD=${AUTH_PASSWORD}
      - ENVIRONMENT=production
      - MAX_EXECUTION_TIME=${MAX_EXECUTION_TIME:-3600}
      - MAX_MEMORY_MB=${MAX_MEMORY_MB:-512}
      # Evitar deadlocks com bibliotecas de ML ao fazer fork
      - TOKENIZERS_PARALLELISM=false

    # Volumes montados
    volumes:
      # Dados persistentes (conversas, uploads, ChromaDB)
      - ./data:/app/data
      # Frontend - arquivos estáticos servidos pelo FastAPI
      - ./frontend:/app/frontend:ro
      # Socket Docker para gerenciar containers (somente leitura)
      - /var/run/docker.sock:/var/run/docker.sock:ro

    # Redes
    networks:
      # Rede do Traefik para receber tráfego externo
      - root_default
      # Rede interna para comunicação com containers sandbox
      - zeus-internal

    # Labels do Traefik para roteamento HTTPS
    labels:
      - "traefik.enable=true"
      # Serviço interno na porta 8000
      - "traefik.http.services.zeus.loadbalancer.server.port=8000"
      # Roteador HTTPS com domínio
      - "traefik.http.routers.zeus.rule=Host(`zeus.ovictorfarias.com.br`)"
      - "traefik.http.routers.zeus.tls=true"
      - "traefik.http.routers.zeus.tls.certresolver=mytlschallenge"
      - "traefik.http.routers.zeus.entrypoints=web,websecure"
      # Rede usada pelo Traefik
      - "traefik.docker.network=root_default"

      # Middlewares para timeouts longos (1h)
      - "traefik.http.middlewares.zeus-timeout.buffering.retryExpression=IsNetworkError() && Attempts() <= 2"
      - "traefik.http.routers.zeus.middlewares=zeus-timeout"

# =====================================================
# REDES
# =====================================================
networks:
  # Rede externa do Traefik (já existente na VPS)
  root_default:
    external: true
  # Rede interna isolada para containers sandbox
  zeus-internal:
    driver: bridge
